{% extends "base.html" %}

{% block title %}Nova Ocorrência - Sentinela IA{% endblock %}

{% block head_extra %}
<style>
    /* Estilos específicos da página de nova ocorrência */
    .search-vehicle-container {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        border-radius: 1rem;
        padding: 2rem;
        margin-bottom: 2rem;
        color: white;
        box-shadow: 0 10px 25px rgba(16, 185, 129, 0.3);
    }

    .search-vehicle-form {
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        border-radius: 0.75rem;
        padding: 1.5rem;
        border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .vehicle-input {
        background: rgba(255, 255, 255, 0.9);
        border: 2px solid transparent;
        color: #374151;
        font-weight: 500;
        font-size: 1.1rem;
        text-transform: uppercase;
    }

    .vehicle-input:focus {
        background: white;
        border-color: #10b981;
        box-shadow: 0 0 0 4px rgba(16, 185, 129, 0.2);
    }

    .search-vehicle-btn {
        background: linear-gradient(135deg, #059669 0%, #047857 100%);
        box-shadow: 0 4px 15px rgba(5, 150, 105, 0.4);
        transition: all 0.3s ease;
    }

    .search-vehicle-btn:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(5, 150, 105, 0.6);
    }

    .form-container {
        background: white;
        border-radius: 1rem;
        overflow: hidden;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        margin-bottom: 1.5rem;
        transition: all 0.3s ease;
    }

    .form-container:hover {
        box-shadow: 0 8px 15px rgba(0, 0, 0, 0.1);
    }

    .form-header {
        background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
        padding: 1.5rem;
        border-bottom: 1px solid #e5e7eb;
        font-weight: 600;
        color: #374151;
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .form-content {
        padding: 2rem;
    }

    .form-section {
        margin-bottom: 2rem;
        padding: 1.5rem;
        background: #f8fafc;
        border-radius: 0.75rem;
        border: 1px solid #e5e7eb;
        transition: all 0.3s ease;
    }

    .form-section.active {
        background: #eff6ff;
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    .form-section.hidden {
        display: none;
    }

    .section-title {
        font-size: 1.1rem;
        font-weight: 600;
        color: #374151;
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .field-group {
        margin-bottom: 1.5rem;
    }

    .field-label {
        display: block;
        font-weight: 500;
        color: #374151;
        margin-bottom: 0.5rem;
        font-size: 0.9rem;
    }

    .field-input, .field-select, .field-textarea {
        width: 100%;
        padding: 0.75rem;
        border: 2px solid #e5e7eb;
        border-radius: 0.5rem;
        font-size: 0.9rem;
        transition: all 0.3s ease;
        background: white;
    }

    .field-input:focus, .field-select:focus, .field-textarea:focus {
        outline: none;
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    .field-input.error, .field-select.error, .field-textarea.error {
        border-color: #ef4444;
        box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.1);
    }

    .field-input.success, .field-select.success, .field-textarea.success {
        border-color: #10b981;
        box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
    }

    .dynamic-section {
        background: white;
        border: 2px dashed #d1d5db;
        border-radius: 0.75rem;
        padding: 1.5rem;
        margin-bottom: 1rem;
        transition: all 0.3s ease;
        position: relative;
    }

    .dynamic-section:hover {
        border-color: #3b82f6;
        background: #f8fafc;
    }

    .dynamic-section.filled {
        border-style: solid;
        border-color: #10b981;
        background: #f0fdf4;
    }

    .remove-btn {
        position: absolute;
        top: 0.5rem;
        right: 0.5rem;
        background: #ef4444;
        color: white;
        border: none;
        border-radius: 50%;
        width: 2rem;
        height: 2rem;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.2s ease;
        font-weight: bold;
    }

    .remove-btn:hover {
        background: #dc2626;
        transform: scale(1.1);
    }

    .add-btn {
        background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);
        color: white;
        border: none;
        padding: 0.75rem 1.5rem;
        border-radius: 0.5rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .add-btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4);
    }

    .submit-btn {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        color: white;
        border: none;
        padding: 1rem 2rem;
        border-radius: 0.75rem;
        font-weight: 600;
        font-size: 1.1rem;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.75rem;
        width: 100%;
    }

    .submit-btn:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(16, 185, 129, 0.4);
    }

    .submit-btn:disabled {
        background: #d1d5db;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
    }

    .type-selector {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin-bottom: 1.5rem;
    }

    .type-option {
        position: relative;
        cursor: pointer;
    }

    .type-option input[type="radio"] {
        position: absolute;
        opacity: 0;
        pointer-events: none;
    }

    .type-option-label {
        display: block;
        padding: 1rem;
        border: 2px solid #e5e7eb;
        border-radius: 0.75rem;
        text-align: center;
        transition: all 0.3s ease;
        background: white;
        font-weight: 500;
    }

    .type-option input:checked + .type-option-label {
        border-color: #3b82f6;
        background: #eff6ff;
        color: #1e40af;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    .type-option-label:hover {
        border-color: #9ca3af;
        background: #f9fafb;
    }

    .feedback-container {
        margin-top: 1.5rem;
        padding: 1rem;
        border-radius: 0.5rem;
        font-weight: 500;
    }

    .feedback-success {
        background: #d1fae5;
        color: #065f46;
        border: 1px solid #a7f3d0;
    }

    .feedback-error {
        background: #fee2e2;
        color: #991b1b;
        border: 1px solid #fecaca;
    }

    .progress-indicator {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-bottom: 2rem;
        padding: 1rem;
        background: #f1f5f9;
        border-radius: 0.75rem;
        border: 1px solid #cbd5e1;
    }

    .progress-step {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 1rem;
        border-radius: 0.5rem;
        font-size: 0.9rem;
        font-weight: 500;
        transition: all 0.3s ease;
    }

    .progress-step.active {
        background: #3b82f6;
        color: white;
    }

    .progress-step.completed {
        background: #10b981;
        color: white;
    }

    .progress-step.pending {
        background: #e5e7eb;
        color: #6b7280;
    }

    .datetime-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
    }

    .validation-tip {
        font-size: 0.8rem;
        color: #6b7280;
        margin-top: 0.25rem;
        display: flex;
        align-items: center;
        gap: 0.25rem;
    }

    .required-indicator {
        color: #ef4444;
        font-weight: bold;
    }

    .empty-state {
        text-align: center;
        padding: 3rem;
        color: #6b7280;
    }

    .empty-state-icon {
        width: 4rem;
        height: 4rem;
        margin: 0 auto 1rem;
        opacity: 0.5;
    }

    @media (max-width: 768px) {
        .search-vehicle-container {
            padding: 1rem;
        }

        .search-vehicle-form {
            padding: 1rem;
        }

        .form-content {
            padding: 1rem;
        }

        .form-section {
            padding: 1rem;
        }

        .type-selector {
            grid-template-columns: 1fr;
        }

        .datetime-grid {
            grid-template-columns: 1fr;
        }

        .progress-indicator {
            flex-wrap: wrap;
        }
    }

    /* Animações */
    @keyframes slideInUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .slide-in {
        animation: slideInUp 0.4s ease-out;
    }

    @keyframes pulse {
        0%, 100% {
            transform: scale(1);
        }
        50% {
            transform: scale(1.05);
        }
    }

    .pulse {
        animation: pulse 2s infinite;
    }
</style>
{% endblock %}

{% block content %}
<div class="fade-in">
    <!-- Page Header -->
    <div class="page-header">
        <h1 class="text-3xl font-bold text-gray-800 flex items-center gap-3">
            <svg class="w-8 h-8 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
            </svg>
            Nova Ocorrência
        </h1>
        <p class="text-gray-600 mt-2">Registre uma nova ocorrência no sistema</p>
    </div>

    <!-- Vehicle Search Section -->
    <div class="search-vehicle-container">
        <div class="search-vehicle-form">
            <h2 class="text-xl font-semibold mb-4 flex items-center gap-2">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21l-2-2m-2-2v-4a6 6 0 000-12h-4a6 6 0 000 12v4l-2 2-2-2v-4a8 8 0 010-16h4a8 8 0 010 16v4l-2 2z"></path>
                </svg>
                1. Buscar Veículo
            </h2>
            
            <div class="mb-4">
                <label for="nova-ocorrencia-search-input" class="field-label text-white flex items-center gap-2">
                    <span class="required-indicator">*</span>
                    Digite a Placa do Veículo:
                </label>
                <div class="relative">
                    <input type="text" 
                           id="nova-ocorrencia-search-input" 
                           class="vehicle-input w-full p-3 pr-12 rounded-lg font-medium placeholder-gray-500 transition-all duration-300" 
                           placeholder="Ex: ABC1234"
                           autocomplete="off"
                           maxlength="7" />
                    <div class="absolute right-3 top-1/2 transform -translate-y-1/2">
                        <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21l-2-2m-2-2v-4a6 6 0 000-12h-4a6 6 0 000 12v4l-2 2-2-2v-4a8 8 0 010-16h4a8 8 0 010 16v4l-2 2z"></path>
                        </svg>
                    </div>
                </div>
                <div id="placa-validation" class="validation-tip mt-1"></div>
            </div>

            <button id="nova-ocorrencia-search-btn" class="search-vehicle-btn w-full py-3 px-6 rounded-lg font-semibold flex items-center justify-center gap-2 transition-all duration-300">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                </svg>
                Buscar Veículo
            </button>
        </div>

        <!-- Quick Help -->
        <div class="mt-4 text-center">
            <p class="text-white/80 text-sm">
                💡 <strong>Dica:</strong> Digite a placa completa do veículo para continuar
            </p>
        </div>
    </div>

    <!-- Form Container -->
    <div id="nova-ocorrencia-form-container">
        <!-- Initial empty state -->
        <div class="empty-state">
            <svg class="empty-state-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21l-2-2m-2-2v-4a6 6 0 000-12h-4a6 6 0 000 12v4l-2 2-2-2v-4a8 8 0 010-16h4a8 8 0 010 16v4l-2 2z"></path>
            </svg>
            <h3 class="text-lg font-semibold text-gray-700">Aguardando busca de veículo</h3>
            <p class="text-gray-500 mt-2">Digite a placa de um veículo para começar</p>
        </div>
    </div>
</div>

<!-- Templates para JavaScript -->
<template id="occurrence-form-template">
    <div class="form-container slide-in">
        <div class="form-header">
            <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
            </svg>
            2. Inserir Nova Ocorrência
            <div class="ml-auto">
                <span class="status-indicator status-success">
                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                    </svg>
                    Veículo Encontrado
                </span>
            </div>
        </div>
        
        <div class="form-content">
            <!-- Progress Indicator -->
            <div class="progress-indicator">
                <div class="progress-step completed">
                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                    </svg>
                    Veículo
                </div>
                <div class="progress-step active">
                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M10 12a2 2 0 100-4 2 2 0 000 4z"></path>
                        <path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.064 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd"></path>
                    </svg>
                    Ocorrência
                </div>
                <div class="progress-step pending">
                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                    </svg>
                    Finalizar
                </div>
            </div>

            <form id="ocorrencia-form" class="space-y-6">
                <input type="hidden" id="veiculo-id" />

                <!-- Type Selection -->
                <div class="form-section active">
                    <div class="section-title">
                        <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.99 1.99 0 013 12V7a4 4 0 014-4z"></path>
                        </svg>
                        Tipo de Ocorrência <span class="required-indicator">*</span>
                    </div>
                    
                    <div class="type-selector">
                        <div class="type-option">
                            <input type="radio" id="tipo-abordagem" name="tipo-ocorrencia" value="Abordagem" />
                            <label for="tipo-abordagem" class="type-option-label">
                                <svg class="w-8 h-8 mx-auto mb-2 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                                </svg>
                                <div class="font-semibold">Abordagem</div>
                                <div class="text-sm text-gray-500 mt-1">Fiscalização de rotina</div>
                            </label>
                        </div>
                        
                        <div class="type-option">
                            <input type="radio" id="tipo-bop" name="tipo-ocorrencia" value="BOP" />
                            <label for="tipo-bop" class="type-option-label">
                                <svg class="w-8 h-8 mx-auto mb-2 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                                </svg>
                                <div class="font-semibold">BOP</div>
                                <div class="text-sm text-gray-500 mt-1">Busca e apreensão</div>
                            </label>
                        </div>
                        
                        <div class="type-option">
                            <input type="radio" id="tipo-entrega" name="tipo-ocorrencia" value="Local de Entrega" />
                            <label for="tipo-entrega" class="type-option-label">
                                <svg class="w-8 h-8 mx-auto mb-2 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                </svg>
                                <div class="font-semibold">Local de Entrega</div>
                                <div class="text-sm text-gray-500 mt-1">Entrega de substâncias</div>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Basic Information -->
                <div class="form-section" id="basic-info-section">
                    <div class="section-title">
                        <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3a2 2 0 012-2h4a2 2 0 012 2v4m-6 0V5a2 2 0 012-2h4a2 2 0 012 2v2m-6 0h6m-6 0l-1 12a2 2 0 002 2h6a2 2 0 002-2l-1-12m-6 0V9a2 2 0 012-2h4a2 2 0 012 2v2"></path>
                        </svg>
                        Informações Básicas
                    </div>

                    <div class="field-group">
                        <label for="datahora-inicio" class="field-label">
                            Data e Hora Inicial <span class="required-indicator">*</span>
                        </label>
                        <input type="text" 
                               id="datahora-inicio" 
                               class="field-input" 
                               placeholder="dd/mm/aaaa hh:mm" />
                        <div class="validation-tip">
                            <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
                            </svg>
                            Formato: DD/MM/AAAA HH:MM
                        </div>
                    </div>

                    <!-- Data fim para Local de Entrega -->
                    <div id="data-fim-group" class="field-group hidden">
                        <label for="datahora-fim" class="field-label">Data e Hora Final</label>
                        <input type="text" 
                               id="datahora-fim" 
                               class="field-input" 
                               placeholder="dd/mm/aaaa hh:mm" />
                    </div>

                    <!-- Cidade para Local de Entrega -->
                    <div id="cidade-entrega-group" class="field-group hidden">
                        <label for="cidade-entrega-select" class="field-label">
                            Cidade da Entrega <span class="required-indicator">*</span>
                        </label>
                        <select id="cidade-entrega-select" class="field-select">
                            <option value="">Carregando cidades...</option>
                        </select>
                    </div>

                    <!-- Relato -->
                    <div id="relato-group" class="field-group">
                        <label for="relato" class="field-label">
                            Relato <span class="required-indicator">*</span>
                        </label>
                        <textarea id="relato" 
                                  rows="4" 
                                  class="field-textarea" 
                                  placeholder="Descreva os detalhes da ocorrência..."></textarea>
                        <div class="validation-tip">
                            <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
                            </svg>
                            Seja detalhado e preciso na descrição
                        </div>
                    </div>
                </div>

                <!-- Dynamic Sections (hidden by default) -->
                <!-- Ocupantes (Abordagem) -->
                <div id="ocupantes-section" class="form-section hidden">
                    <div class="section-title">
                        <svg class="w-5 h-5 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m13.5-4.5v2a2 2 0 01-2 2h-4a2 2 0 01-2-2v-2a2 2 0 012-2h4a2 2 0 012 2z"></path>
                        </svg>
                        Ocupantes do Veículo
                    </div>
                    <div id="ocupantes-container" class="space-y-4 mb-4"></div>
                    <button type="button" id="add-ocupante-btn" class="add-btn">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                        </svg>
                        Adicionar Ocupante
                    </button>
                </div>

                <!-- Veículos Envolvidos -->
                <div id="veiculos-envolvidos-section" class="form-section hidden">
                    <div class="section-title">
                        <svg class="w-5 h-5 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21l-2-2m-2-2v-4a6 6 0 000-12h-4a6 6 0 000 12v4l-2 2-2-2v-4a8 8 0 010-16h4a8 8 0 010 16v4l-2 2z"></path>
                        </svg>
                        Veículos Envolvidos
                    </div>
                    <div id="veiculos-envolvidos-container" class="space-y-4 mb-4"></div>
                    <button type="button" id="add-veiculo-btn" class="add-btn">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                        </svg>
                        Adicionar Veículo
                    </button>
                </div>

                <!-- BOP Details -->
                <div id="bop-section" class="form-section hidden">
                    <!-- Apreensões -->
                    <div class="mb-6">
                        <div class="section-title">
                            <svg class="w-5 h-5 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path>
                            </svg>
                            Apreensões
                        </div>
                        <div id="apreensoes-container" class="space-y-4 mb-4"></div>
                        <button type="button" id="add-apreensao-btn" class="add-btn">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                            </svg>
                            Adicionar Apreensão
                        </button>
                    </div>

                    <!-- Presos -->
                    <div>
                        <div class="section-title">
                            <svg class="w-5 h-5 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                            </svg>
                            Pessoas Presas
                        </div>
                        <div id="presos-container" class="space-y-4 mb-4"></div>
                        <button type="button" id="add-preso-btn" class="add-btn">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                            </svg>
                            Adicionar Preso
                        </button>
                    </div>
                </div>

                <!-- Submit Button -->
                <div class="form-section">
                    <button type="submit" id="submit-btn" class="submit-btn">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                        </svg>
                        Salvar Ocorrência
                    </button>
                    
                    <div id="form-feedback" class="feedback-container hidden"></div>
                </div>
            </form>
        </div>
    </div>
</template>

<!-- Dynamic Field Templates -->
<template id="ocupante-template">
    <div class="dynamic-section">
        <button type="button" class="remove-btn" onclick="this.closest('.dynamic-section').remove()">×</button>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
                <label class="field-label">Nome Completo</label>
                <input type="text" name="ocupante-nome" class="field-input" placeholder="Nome do ocupante" />
            </div>
            <div>
                <label class="field-label">CPF/CNPJ</label>
                <input type="text" name="ocupante-cpf" class="field-input" placeholder="000.000.000-00" />
            </div>
        </div>
    </div>
</template>

<template id="veiculo-template">
    <div class="dynamic-section">
        <button type="button" class="remove-btn" onclick="this.closest('.dynamic-section').remove()">×</button>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
                <label class="field-label">Placa</label>
                <input type="text" name="veiculo-placa" class="field-input" placeholder="ABC1234" style="text-transform: uppercase;" />
            </div>
            <div>
                <label class="field-label">Modelo</label>
                <input type="text" name="veiculo-modelo" class="field-input" placeholder="Marca/Modelo" />
            </div>
        </div>
    </div>
</template>

<template id="apreensao-template">
    <div class="dynamic-section">
        <button type="button" class="remove-btn" onclick="this.closest('.dynamic-section').remove()">×</button>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div>
                <label class="field-label">Tipo <span class="required-indicator">*</span></label>
                <select name="apreensao-tipo" class="field-select">
                    <option value="">Selecione...</option>
                    <option value="Maconha">Maconha</option>
                    <option value="Skunk">Skunk</option>
                    <option value="Cocaina">Cocaína</option>
                    <option value="Crack">Crack</option>
                    <option value="Sintéticos">Sintéticos</option>
                    <option value="Arma">Arma</option>
                </select>
            </div>
            <div>
                <label class="field-label">Quantidade <span class="required-indicator">*</span></label>
                <input type="number" step="any" name="apreensao-qtd" class="field-input" placeholder="0.00" />
            </div>
            <div>
                <label class="field-label">Unidade <span class="required-indicator">*</span></label>
                <select name="apreensao-unidade" class="field-select">
                    <option value="">Selecione...</option>
                    <option value="kg">Quilogramas (kg)</option>
                    <option value="g">Gramas (g)</option>
                    <option value="un">Unidades (un)</option>
                </select>
            </div>
        </div>
    </div>
</template>

<template id="preso-template">
    <div class="dynamic-section">
        <button type="button" class="remove-btn" onclick="this.closest('.dynamic-section').remove()">×</button>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
                <label class="field-label">Nome Completo</label>
                <input type="text" name="preso-nome" class="field-input" placeholder="Nome da pessoa presa" />
            </div>
            <div>
                <label class="field-label">CPF/CNPJ</label>
                <input type="text" name="preso-cpf" class="field-input" placeholder="000.000.000-00" />
            </div>
        </div>
    </div>
</template>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/nova_ocorrencia.js') }}"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Enhanced vehicle search with validation
    const vehicleInput = document.getElementById('nova-ocorrencia-search-input');
    const searchBtn = document.getElementById('nova-ocorrencia-search-btn');
    const placaValidation = document.getElementById('placa-validation');

    // Real-time placa validation
    function validatePlaca() {
        const value = vehicleInput.value.trim();
        
        if (!value) {
            placaValidation.innerHTML = '';
            vehicleInput.style.borderColor = '';
            return false;
        }

        const validation = Validators.validatePlaca(value);
        
        if (validation.valid) {
            vehicleInput.style.borderColor = '#10b981';
            placaValidation.innerHTML = `<span class="text-green-600">✓ ${validation.message}</span>`;
            return true;
        } else {
            vehicleInput.style.borderColor = '#ef4444';
            placaValidation.innerHTML = `<span class="text-red-600">✗ ${validation.message}</span>`;
            return false;
        }
    }

    // Enhanced search button
    async function handleEnhancedSearch() {
        const placa = vehicleInput.value.trim();
        
        if (!placa) {
            showToast('Por favor, digite a placa do veículo', 'warning');
            vehicleInput.focus();
            return;
        }

        if (!validatePlaca()) {
            showToast('Placa inválida. Verifique o formato.', 'error');
            vehicleInput.focus();
            return;
        }

        // Show loading state
        searchBtn.disabled = true;
        searchBtn.innerHTML = `
            <svg class="animate-spin w-5 h-5" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="m4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            Buscando...
        `;

        try {
            // Call original search function
            if (window.handleNovaOcorrenciaSearch) {
                await window.handleNovaOcorrenciaSearch(placa);
                showToast('Veículo encontrado! Preencha os dados da ocorrência.', 'success');
            }
        } catch (error) {
            showToast('Erro na busca: ' + error.message, 'error');
        } finally {
            // Restore button
            searchBtn.disabled = false;
            searchBtn.innerHTML = `
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                </svg>
                Buscar Veículo
            `;
        }
    }

    // Event listeners
    vehicleInput.addEventListener('input', function() {
        this.value = this.value.toUpperCase();
        validatePlaca();
    });

    vehicleInput.addEventListener('keyup', function(e) {
        if (e.key === 'Enter' && validatePlaca()) {
            handleEnhancedSearch();
        }
    });

    searchBtn.addEventListener('click', handleEnhancedSearch);

    // Enhanced form validation when form is created
    document.addEventListener('DOMContentLoaded', function() {
        // This will be called after the form is dynamically created
        setTimeout(function() {
            enhanceFormFields();
        }, 1000);
    });

    // Enhance form fields with validation
    function enhanceFormFields() {
        // Date/time fields
        const dateTimeInputs = document.querySelectorAll('#datahora-inicio, #datahora-fim');
        dateTimeInputs.forEach(input => {
            if (input) {
                applyRealTimeValidation(input, function(value) {
                    return Validators.validateDateTime(value);
                }, function(result, field) {
                    showValidationMessage(field, result.message, result.valid ? 'success' : 'error');
                });
            }
        });

        // CPF fields
        const cpfInputs = document.querySelectorAll('input[name*="cpf"]');
        cpfInputs.forEach(input => {
            if (input) {
                applyRealTimeValidation(input, function(value) {
                    return Validators.validateCpfCnpj(value);
                }, function(result, field) {
                    if (result.valid) {
                        field.value = Validators.formatCpfCnpj(field.value);
                    }
                    showValidationMessage(field, result.message, result.valid ? 'success' : 'error');
                });
            }
        });

        // Placa fields
        const placaInputs = document.querySelectorAll('input[name*="placa"]');
        placaInputs.forEach(input => {
            if (input) {
                input.addEventListener('input', function() {
                    this.value = this.value.toUpperCase();
                });
                
                applyRealTimeValidation(input, function(value) {
                    return Validators.validatePlaca(value);
                }, function(result, field) {
                    showValidationMessage(field, result.message, result.valid ? 'success' : 'error');
                });
            }
        });
    }

    // Enhanced form submission
    document.addEventListener('submit', function(e) {
        if (e.target.id === 'ocorrencia-form') {
            e.preventDefault();
            
            // Validate all fields before submission
            const form = e.target;
            let isValid = true;
            const errors = [];

            // Check required fields
            const requiredFields = form.querySelectorAll('[required], .field-input[data-required="true"]');
            requiredFields.forEach(field => {
                if (!field.value.trim()) {
                    isValid = false;
                    field.style.borderColor = '#ef4444';
                    errors.push(`${field.previousElementSibling?.textContent || 'Campo'} é obrigatório`);
                }
            });

            // Validate specific field types
            const dateFields = form.querySelectorAll('#datahora-inicio, #datahora-fim');
            dateFields.forEach(field => {
                if (field.value && !Validators.validateDateTime(field.value).valid) {
                    isValid = false;
                    errors.push('Data/hora inválida: ' + field.id);
                }
            });

            if (!isValid) {
                showToast('Corrija os erros no formulário: ' + errors.join(', '), 'error');
                return;
            }

            // Update progress indicator
            const progressSteps = document.querySelectorAll('.progress-step');
            progressSteps.forEach(step => {
                step.classList.remove('active');
                step.classList.add('completed');
            });

            // Show loading
            showLoading('Salvando ocorrência...');

            // Continue with original form submission
            // (The original nova_ocorrencia.js will handle the actual submission)
        }
    });

    // Keyboard shortcuts
    document.addEventListener('keydown', function(e) {
        // Ctrl+Enter to submit form
        if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
            const form = document.getElementById('ocorrencia-form');
            if (form && form.style.display !== 'none') {
                form.dispatchEvent(new Event('submit'));
            }
        }
    });
});
</script>
{% endblock %}