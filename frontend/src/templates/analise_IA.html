{% extends "base.html" %}

{% block title %}Análise por Placa - Sentinela IA{% endblock %}

{% block head_extra %}
<style>
    /* Estilos específicos da página de Análise IA */
    .search-ia-container {
        background: linear-gradient(135deg, #4c1d95 0%, #6d28d9 100%);
        border-radius: 1rem;
        padding: 2rem;
        margin-bottom: 2rem;
        color: white;
        box-shadow: 0 10px 25px rgba(109, 40, 217, 0.3);
    }

    .search-ia-form {
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        border-radius: 0.75rem;
        padding: 1.5rem;
        border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .ia-input {
        background: rgba(255, 255, 255, 0.9);
        border: 2px solid transparent;
        color: #374151;
        font-weight: 500;
        font-size: 1.1rem;
        text-transform: uppercase;
    }

    .ia-input:focus {
        background: white;
        border-color: #6d28d9;
        box-shadow: 0 0 0 4px rgba(109, 40, 217, 0.2);
    }

    .analisar-btn {
        background: linear-gradient(135deg, #6d28d9 0%, #4c1d95 100%);
        box-shadow: 0 4px 15px rgba(109, 40, 217, 0.4);
        transition: all 0.3s ease;
    }

    .analisar-btn:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(109, 40, 217, 0.6);
    }

    .kpi-box.risk-ia {
        border-left-color: #6d28d9;
        background: linear-gradient(135deg, #f3e8ff 0%, #e9d5ff 100%);
        color: #4c1d95;
    }

    .kpi-box.risk-ia .kpi-value {
        color: #4c1d95;
    }

    .kpi-box.risk-ia .kpi-label {
        color: #6d28d9;
    }

    .data-card.risk-report {
        border-left: 4px solid #6d28d9;
        background: #f8f1ff;
    }

    .loading-ia {
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 3rem;
        color: #6d28d9;
    }

    .loading-ia .loader {
        border-top-color: #6d28d9;
    }
</style>
{% endblock %}

{% block content %}
<div class="fade-in">
    <!-- Page Header -->
    <div class="page-header">
        <h1 class="text-3xl font-bold text-gray-800 flex items-center gap-3">
            <svg class="w-8 h-8 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
            </svg>
            Análise por Placa
        </h1>
        <p class="text-gray-600 mt-2">Utilize o poder da inteligência artificial para analisar o risco de uma placa</p>
    </div>

    <!-- Search Section -->
    <div class="search-ia-container">
        <div class="search-ia-form">
            <h2 class="text-xl font-semibold mb-4 flex items-center gap-2 text-white">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                </svg>
                Análise Inteligente
            </h2>
            
            <div class="mb-4">
                <label for="placa-input" class="field-label text-white flex items-center gap-2">
                    <span class="required-indicator">*</span>
                    Digite a Placa do Veículo:
                </label>
                <div class="relative">
                    <input type="text" 
                           id="placa-input" 
                           class="ia-input w-full p-3 pr-12 rounded-lg font-medium placeholder-gray-500 transition-all duration-300" 
                           placeholder="Ex: ABC1234"
                           autocomplete="off"
                           maxlength="7" />
                    <div class="absolute right-3 top-1/2 transform -translate-y-1/2">
                        <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21l-2-2m-2-2v-4a6 6 0 000-12h-4a6 6 0 000 12v4l-2 2-2-2v-4a8 8 0 010-16h4a8 8 0 010 16v4l-2 2z"></path>
                        </svg>
                    </div>
                </div>
                <div id="placa-validation" class="validation-tip mt-1"></div>
            </div>

            <button id="analisar-btn" class="analisar-btn w-full py-3 px-6 rounded-lg font-semibold flex items-center justify-center gap-2 transition-all duration-300">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                </svg>
                Analisar Placa
            </button>
        </div>
    </div>

    <!-- Results Section -->
    <div id="analise-resultados" class="space-y-6">
        <!-- Initial empty state -->
        <div class="empty-state">
            <svg class="empty-state-icon text-purple-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
            </svg>
            <h3 class="text-lg font-semibold text-gray-700">Análise pronta para começar</h3>
            <p class="text-gray-500 mt-2">Digite uma placa para obter uma análise completa do seu risco</p>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/components/analise_ia.js') }}"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const placaInput = document.getElementById('placa-input');
    const analisarBtn = document.getElementById('analisar-btn');
    const resultadosContainer = document.getElementById('analise-resultados');

    // Funções auxiliares para validação e feedback
    function validatePlaca() {
        const value = placaInput.value.trim();
        const validation = Validators.validatePlaca(value);
        const validationEl = document.getElementById('placa-validation');
        
        placaInput.classList.remove('error', 'success');
        validationEl.innerHTML = '';

        if (value) {
            if (validation.valid) {
                placaInput.classList.add('success');
                validationEl.innerHTML = `<span class="text-green-600">✓ Placa válida</span>`;
            } else {
                placaInput.classList.add('error');
                validationEl.innerHTML = `<span class="text-red-600">✗ Formato de placa inválido</span>`;
            }
        }
        return validation.valid;
    }

    // Manipulador de clique no botão
    const handleAnaliseClick = async () => {
        if (!validatePlaca()) {
            showToast('Por favor, digite uma placa válida', 'error');
            return;
        }

        // Show loading state
        analisarBtn.disabled = true;
        analisarBtn.innerHTML = `
            <svg class="animate-spin w-5 h-5" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="m4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            Analisando...
        `;
        showLoader(resultadosContainer);

        try {
            // A função `handleAnalise` do componente `analise_ia.js` será chamada aqui
            await handleAnalise(placaInput.value);
            showToast('Análise de IA concluída com sucesso!', 'success');
        } catch (error) {
            showToast('Erro na análise: ' + error.message, 'error');
            console.error('Erro na análise:', error);
            resultadosContainer.innerHTML = `<div class="alert alert--error mt-6"><p class="alert__message">❌ Erro ao analisar a placa: ${error.message}</p></div>`;
        } finally {
            // Restore button state
            analisarBtn.disabled = false;
            analisarBtn.innerHTML = `
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                </svg>
                Analisar Placa
            `;
        }
    };
    
    // Configurar event listeners
    placaInput.addEventListener('input', () => {
        placaInput.value = placaInput.value.toUpperCase();
        validatePlaca();
    });
    placaInput.addEventListener('keyup', (event) => {
        if (event.key === 'Enter') {
            handleAnaliseClick();
        }
    });
    analisarBtn.addEventListener('click', handleAnaliseClick);
});
</script>
{% endblock %}
